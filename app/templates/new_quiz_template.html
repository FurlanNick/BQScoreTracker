<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }

        .team-header {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body>
    <h1>Quiz {{ quiz_name }}</h1>

    <table>
        <tr>
            <th>Question</th>
            {% for i in range(1, 4) %}
            <th colspan="2" class="team-header">
                <input type="checkbox" name="on_time_{{ i }}" checked> On Time
                <select name="team_{{ i }}">
                    <option value=""></option>
                    {% for team_name in teams %}
                        <option value="{{ team_name }}">{{ team_name }}</option>
                    {% endfor %}
                </select>
            </th>
            {% endfor %}
        </tr>
        <tr>
            <th></th>
            {% for i in range(1, 4) %}
            <th>Quizzer</th>
            <th>Score</th>
            {% endfor %}
        </tr>
        {% for i in range(1, 21) %}
        <tr>
            <td>{{ i }}</td>
            {% for j in range(1, 4) %}
            <td>
                <select class="quizzer-select" name="quizzer_{{ j }}_{{ i }}">
                    <option value=""></option>
                </select>
            </td>
            <td>
                <select name="score_{{ j }}_{{ i }}">
                    <option value=""></option>
                    <option value="C">C</option>
                    <option value="B">B</option>
                    <option value="E">E</option>
                    <option value="BE">BE</option>
                    <option value="F">F</option>
                    <option value="OUT">OUT</option>
                    <option value="IN">IN</option>
                </select>
            </td>
            {% endfor %}
        </tr>
            {% if i >= 16 %}
                 <tr>
                    <td>{{ i }}b</td>
                    {% for j in range(1, 4) %}
                    <td>
                    </td>
                    <td>
                        <select name="score_{{ j }}_{{ i }}b">
                            <option value=""></option>
                            <option value="C">C</option>
                            <option value="B">B</option>
                            <option value="E">E</option>
                            <option value="BE">BE</option>
                            <option value="F">F</option>
                            <option value="OUT">OUT</option>
                            <option value="IN">IN</option>
                        </select>
                    </td>
                    {% endfor %}
                </tr>
            {% endif %}
        {% endfor %}
        <tr>
            <td>Team Score</td>
            {% for i in range(1, 4) %}
            <td colspan="2" id="team_score_{{ i }}">20</td>
            {% endfor %}
        </tr>
    </table>

    <script>
        const teams = {{ teams | tojson }};
        const teamSelects = document.querySelectorAll('select[name^="team_"]');
        const onTimeCheckboxes = document.querySelectorAll('input[name^="on_time_"]');

        function updateTeamScore(teamIndex) {
            const teamScoreEl = document.getElementById(`team_score_${teamIndex}`);
            let score = 0;

            const onTimeCheckbox = document.querySelector(`input[name="on_time_${teamIndex}"]`);
            if (onTimeCheckbox.checked) {
                score += 20;
            }

            const scoreSelects = document.querySelectorAll(`select[name^="score_${teamIndex}_"]`);
            let correctQuizzers = new Set();
            let personalErrors = {};
            let teamErrors = 0;
            let fouls = 0;

            scoreSelects.forEach(scoreSelect => {
                const quizzerSelect = scoreSelect.parentElement.previousElementSibling.querySelector('.quizzer-select');
                const quizzerName = quizzerSelect.value;

                if (scoreSelect.value === 'C') {
                    score += 20;
                    if (quizzerName) {
                        correctQuizzers.add(quizzerName);
                    }
                } else if (scoreSelect.value === 'E') {
                    teamErrors++;
                    if (quizzerName) {
                        if (!personalErrors[quizzerName]) {
                            personalErrors[quizzerName] = 0;
                        }
                        personalErrors[quizzerName]++;
                        if (personalErrors[quizzerName] > 1) {
                            score -= 10;
                        }
                    }
                    if (teamErrors > 2) {
                        score -= 10;
                    }
                } else if (scoreSelect.value === 'B') {
                    const questionNumber = parseInt(scoreSelect.name.split('_')[2]);
                    if (questionNumber <= 16) {
                        score += 20;
                    } else {
                        score += 10;
                    }
                } else if (scoreSelect.value === 'F') {
                    fouls++;
                    if (fouls > 2) {
                        score -= 10;
                    }
                }
            });

            if (correctQuizzers.size >= 3) {
                score += 10;
            }
            if (correctQuizzers.size >= 4) {
                score += 10;
            }
            if (correctQuizzers.size >= 5) {
                score += 10;
            }

            teamScoreEl.textContent = score;
        }

        teamSelects.forEach((select, index) => {
            const teamIndex = index + 1;
            select.addEventListener('change', (event) => {
                const teamName = event.target.value;
                const quizzerSelects = document.querySelectorAll(`.quizzer-select[name^="quizzer_${teamIndex}_"]`);

                quizzerSelects.forEach(quizzerSelect => {
                    quizzerSelect.innerHTML = '<option value=""></option>';
                    if (teamName && teams[teamName]) {
                        teams[teamName].quizzers.forEach(quizzer => {
                            const option = document.createElement('option');
                            option.value = quizzer;
                            option.textContent = quizzer;
                            quizzerSelect.appendChild(option);
                        });
                    }
                });
                updateTeamScore(teamIndex);
            });
        });

        onTimeCheckboxes.forEach((checkbox, index) => {
            const teamIndex = index + 1;
            checkbox.addEventListener('change', () => {
                updateTeamScore(teamIndex);
            });
        });

        const scoreSelects = document.querySelectorAll('select[name^="score_"]');
        scoreSelects.forEach(select => {
            const teamIndex = select.name.split('_')[1];
            select.addEventListener('change', () => {
                updateTeamScore(teamIndex);
            });
        });
    </script>
</body>
</html>
